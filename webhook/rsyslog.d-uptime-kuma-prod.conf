# High-Performance Rsyslog Configuration for Uptime Kuma Logs
# Optimized for production environments with high throughput

# Load required modules
module(load="imfile" PollingInterval="1")  # Faster polling for real-time

# Performance tuning - Global directives
global(
    # Increase queue sizes for high throughput
    maxMessageSize="64k"
    
    # Optimize processing
    processInternalMessages="off"
)

# Main queue configuration for high performance
main_queue(
    queue.size="100000"           # Large queue for burst handling
    queue.workerThreads="4"        # Parallel processing
    queue.dequeueBatchSize="1000"  # Batch processing
    queue.maxDiskSpace="2g"        # Disk-assisted queue for resilience
    queue.saveOnShutdown="on"
    queue.type="LinkedList"        # Memory-based for speed
    queue.highWatermark="80000"
    queue.lowWatermark="60000"
    queue.discardMark="95000"      # Discard under extreme load
    queue.discardSeverity="7"      # Discard debug messages first
)

# Input for webhook log file with state tracking
input(type="imfile"
      File="/srv/uptime-kuma/webhook.log"
      Tag="uptime-kuma"
      Severity="info"
      Facility="local0"
      StateFile="/var/spool/rsyslog/uptime-kuma-state"
      reopenOnTruncate="on"
      readMode="2"                  # Line-based mode for JSON
      maxLinesAtOnce="10000"        # Batch read for performance
      maxSubmitAtOnce="1000"        # Batch submit
      deleteStateOnFileDelete="on"
      )

# Template for efficient JSON forwarding (minimal overhead)
template(name="UptimeKumaJSON" type="list") {
    property(name="msg")
    constant(value="\n")
}

# Action queue for Wazuh forwarding with reliability
action(type="omfwd"
       Target="YOUR_WAZUH_MANAGER_IP"
       Port="1515"
       Protocol="tcp"
       
       # Compression for network efficiency
       compression.mode="stream:always"
       compression.stream.flushOnTXEnd="on"
       
       # Use efficient template
       template="UptimeKumaJSON"
       
       # TCP connection optimization
       TCP_Framing="octet-counted"
       KeepAlive="on"
       KeepAlive.Probes="3"
       KeepAlive.Interval="10"
       KeepAlive.Time="60"
       
       # Queue for this action (resilience)
       queue.type="LinkedList"
       queue.size="50000"
       queue.workerThreads="2"
       queue.dequeueBatchSize="500"
       queue.maxDiskSpace="1g"
       queue.saveOnShutdown="on"
       queue.highWatermark="40000"
       queue.lowWatermark="20000"
       queue.discardMark="45000"
       queue.discardSeverity="7"
       
       # Retry logic for network issues
       action.resumeRetryCount="-1"   # Infinite retries
       action.resumeInterval="10"      # Retry every 10 seconds
       
       # Rate limiting (prevent overwhelming Wazuh)
       RateLimit.Interval="0"          # Disable if you trust your limits
       RateLimit.Burst="20000"
       )

# Stop processing after forwarding (don't log locally again)
& stop